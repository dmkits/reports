<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div id="`saStartupParams_PageContent" style="width:510px;height:100%; margin:0;padding:0;">
    <table width="100%">
        <tr>
            <td height="20px" width="330px">
            <table width="315px">
                    <tr>
                        <th height="30px"><b>system startup parameters:</b></th>
                        <th  height="30px">
                            <div id="`saStartupParams_appLocalConfig">default</div>
                        </th>
                        <th></th>
                    </tr>
                </table>
            </td>
            <td height="20px">
                <table width="200px">
                    <tr>
                        <th id="server_db_list_th" height="30px"><b>Database list: </b></th>   <!--"height="30px"-->
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td height="1px">
                <table width="500px">
                    <tr>
                        <td><label for="db.server">db.server </label></td>
                        <td><input id="db.server" type="text" aria-disabled="false"/></td>
                    </tr>
                    <tr>
                        <td><label for="db.port">db.port </label></td>
                        <td><input id="db.port" type="text" aria-disabled="false"/></td>
                    </tr>
                    <tr>
                        <td><label for="db.name">db.name </label></td>
                        <td><input id="db.name" type="text" aria-disabled="false"/></td>
                    </tr>
                    <tr>
                        <td><label for="db.user">db.user </label></td>
                        <td><input id="db.user" type="text" aria-disabled="false"/></td>
                    </tr>
                    <tr>
                        <td><label for="db.password">db.password </label></td>
                        <td><input id="db.password" type="text" aria-disabled="false"/></td>
                    </tr>
                    <tr>
                        <td><label for="reports.config">reports.config</label></td>
                        <td><input id="reports.config" type="text" aria-disabled="false"/></td>
                    </tr>
                </table>
            </td>
            <td height="120x">
                <table width="200px">
                    <tr>
                        <td><div  id="db_list" style="height:120px; overflow-y:scroll"></div></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td height="30px">
                <button id="`saStartupParams_BtnAppLocalConfigLoad">Load settings</button>
                <button id="`saStartupParams_BtnAppLocalConfigSaveAndReconnect">Store settings & reconnect to
                    database
                </button>
            </td>
        </tr>
    </table>
</div>
</body>
<script type="text/javascript">
    require(["dojo.app/app", "dijit/layout/BorderContainer", "dijit/layout/LayoutContainer", "dijit/layout/ContentPane", "dojo/data/ItemFileReadStore",
                "dijit/form/TextBox", "dijit/form/DateTextBox", "dijit/form/Button","dojo.app/request",'dojo.app/sysadminDialogs'],
            function (APP, BorderContainer, LayoutContainer, ContentPane, ItemFileReadStore, TextBox, DateTextBox, Button, Request, sysadminDialogs) {
                var pageContent = APP.instanceForID("`saStartupParams_PageContent", ContentPane, {});
                var hostInput=new TextBox({id:"db.server"},"db.server");
                var portInput=new TextBox({id:"db.port"},"db.port");
                var databaseInput=new TextBox({id:"db.name"},"db.name");
                var userInput=new TextBox({id:"db.user"},"db.user");
                var dbPasswordInput=new TextBox({id:"db.password"},"db.password"); //reports.config
                var reportsConfigInput=new TextBox({id:"reports.config"},"reports.config");
                var appLocalConfig = document.getElementById("`saStartupParams_appLocalConfig");
                var reloadBtn = new Button({id: "`saStartupParams_BtnAppLocalConfigLoad"}, "`saStartupParams_BtnAppLocalConfigLoad");
                var saveAndReconnectBtn = new Button({id: "`saStartupParams_BtnAppLocalConfigSaveAndReconnect"}, "`saStartupParams_BtnAppLocalConfigSaveAndReconnect");

                pageContent.getAppConfiguration = function(){
                    Request.getJSONData({url: "/sysadmin/startupParameters/get_app_config", consoleLog: true},
                        function (result) {
                            if (!result) {
                                appLocalConfig.innerHTML = "<div><b style='color:red'>No connection to the server!</b></div>";
                                return;
                            }
                            if (result.error) {
                                appLocalConfig.innerHTML = "<div><b style='color:red'>Cannot get configuration parameters!</b> Reason:"+result.error+"</div>";
                                return;
                            }
                            if(result.dbList){
                                var DBArray=result.dbList;
                                var DBstr="";
                                for(var i in DBArray){
                                    DBstr=DBstr+DBArray[i].name+"\n";
                                }
                                document.getElementById("db_list").innerText=DBstr;
                            }
                            appLocalConfig.innerHTML = "<div><b>Configuration loaded.</b></div>";
                            setDBConfigContent(result);
                        })
                };
                reloadBtn.onClick= function() {
                    appLocalConfig.innerHTML = "<div><b>Loading configuration parameters...</b></div>";
                    Request.getJSONData({url: "/sysadmin/startupParameters/loadAppConfig", consoleLog: true},
                            function (result) {
                                if (result==undefined) {
                                    appLocalConfig.innerHTML = "<div><b style='color:red'>No connection to the server!</b></div>";
                                    return;
                                }
                                if (result.error) {
                                    appLocalConfig.innerHTML = "<div><b style='color:red'>Cannot load configuration parameters!</b> Reason:"+result.error+"</div>";
                                    return;
                                }
                                appLocalConfig.innerHTML = "<div><b>Configuration reloaded.</b></div>";
                                setDBConfigContent(result);
                                if (pageContent.getParent().updateDBState)  pageContent.getParent().updateDBState();
                            }
                    );
                };
                function setDBConfigContent(configData) {
                    hostInput.set("value",configData["server"]);
                    if(configData["port"]) portInput.set("value",configData["port"]);
                    else portInput.set("value","1433");
                    databaseInput.set("value",configData["database"] );
                    userInput.set("value",configData["user"]);
                    dbPasswordInput.set("value",configData["password"]);
                    if(configData["reports.config"])reportsConfigInput.set("value",configData["reports.config"]);
                }

                saveAndReconnectBtn.onClick = function () {
                    var appLocalConfig = document.getElementById("`saStartupParams_appLocalConfig");
                    appLocalConfig.innerHTML = "<div><b>Configuration is saving and reconnecting to database...</b></div>";
                    var newDBConfig={
                        "server": hostInput.get('value'),
                        "port": portInput.get('value'),
                        "database": databaseInput.get('value'),
                        "user": userInput.get('value'),
                        "password": dbPasswordInput.get('value'),
                        "reports.config":reportsConfigInput.get('value')
                    };

                    Request.postJSONData({url:  "/sysadmin/startupParameters/store_app_config_and_reconnect", data: newDBConfig, consoleLog: true},
                        function (data) {
                            if (!data) {
                                appLocalConfig.innerHTML = "<div><b style='color:red'>No connection!</b></div>";
                                return;
                            }
                            if (data.error) {
                                appLocalConfig.innerHTML = "<div><b style='color:red'>Failed store configuration! Reason:" + data["error"] + "</b></div>";
                            } else {
                                appLocalConfig.innerHTML = "<div><b>Configuration saved.</b></div>";
                            }
                            if (data.DBConnectError) {
                                appLocalConfig.innerHTML=
                                    appLocalConfig.innerHTML+ "<br><div><b style='color:red'>Failed connect to database ! Reason:" + data["DBConnectError"] + "</b></div>";
                            } else {
                                appLocalConfig.innerHTML =
                                    appLocalConfig.innerHTML+ "<br><div><b>Reconnected to database.</b></div>";
                            }
                            if (pageContent.getParent().updateDBState)  pageContent.getParent().updateDBState();
                        });
                };

                pageContent.getAppConfiguration();
            });
</script>
</html>