<!DOCTYPE HTML>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div id="simpleReport_PageContainer" style="width:100%;height:100%;">
    <div id="simpleReport_ContentPaneLeft" style="width:177px;height:100%; margin:0;padding:0;">
        <table>
            <tr><th>Отчеты</th></tr>
            <tr><td id="simpleReport_buttonList"></td></tr>
        </table>
    </div>
    <div id="simpleReport_ContentPaneDetailContainer" style="width:100%;height:100%; margin:0;padding:0;"></div>
</div>
</body>
<script type="text/javascript">
    require(["dojo.app/app", "dojo/dom-style", "dijit/layout/BorderContainer", "dijit/layout/StackContainer", "dijit/layout/ContentPane",
                "dijit/form/Button", "dojo.app/tDocumentSimpleTable","dojo.app/request"],
            function (APP, domStyle, BorderContainer, StackContainer, ContentPane, Button, TDocumentSimpleTable, Request) {
                var pageContainer= APP.instanceForID("simpleReport_PageContainer", BorderContainer, {});
                APP.instanceForID("simpleReport_ContentPaneLeft", ContentPane, {region:'left', splitter:true});
                var detailContainer= APP.instanceForID("simpleReport_ContentPaneDetailContainer", StackContainer, {region:'center'});
                var buttonList=document.getElementById("simpleReport_buttonList");
                var firstButton;
                var pageID="<%-pageID%>";
                pageContainer.createReportButtons=function(){
                    Request.getJSONData({url: "/simpleReport/"+pageID+"/getReportsList",consoleLog: true},
                            function (data) {
                                if (data===undefined) {
                                    detailContainer.innerHTML = "<div><b style='color:red'>No connection!</b></div>";
                                    return;
                                }
                                var items=data.items;
                                if(items.length==0){
                                    buttonList.innerHTML="<br><b style=\"color:red\">Нет доступных отчетов</b>"
                                    return;
                                }
                                for (var i in items) {
                                    if(items[i]['id']==undefined){
                                        var div = document.createElement('div');
                                        div.innerHTML='<br>';
                                        document.getElementById('simpleReport_buttonList').appendChild(div);
                                        continue;
                                    }
                                    pageContainer.addButtonTo(buttonList, items[i].id, items[i].name);
                                }
                               firstButton.onClick();
                            });
                };

                pageContainer.addButtonTo = function (parent, id, name) {
                    var button = new Button({id:id, label:name});
                    button.onClick= function(){
                        var instance=this;
                        if (!button.document){
                            var reportBaseURL='/simpleReport/'+pageID;
                            button.document =
                                APP.childFor(detailContainer, "simpleReport_Table"+instance.id,
                                    TDocumentSimpleTable, {titleText:instance.label, dataURL:reportBaseURL+'/getReportDataByReportName/'+instance.id,
                                            rightPane:{ width:350 }});
                            Request.getJSONData({url:reportBaseURL+'/getReportConfigByReportName/'+instance.id}, function(result){
                                var reportConfigHeaders=result.headers, reportConfigTotals=result.totals,
                                        reportConfigSelectedRowInfo=result.selectedRowInfo;
                                if(reportConfigHeaders){
                                    for (var i = 0; i < reportConfigHeaders.length; i++) {
                                        var reportConfigHeaderData = reportConfigHeaders[i];
                                        if(reportConfigHeaderData.type=="selectBox")
                                            button.document.addSelectBox(reportConfigHeaderData.label,reportConfigHeaderData.params);
                                        if(reportConfigHeaderData.type=="dateBox")
                                            button.document.addHeaderDateBox(reportConfigHeaderData.label,reportConfigHeaderData.params)
                                    }
                                }
                                if(reportConfigSelectedRowInfo){
                                    if(!reportConfigSelectedRowInfo.sqlParamFieldName) return;
                                    button.document.addToolPane({title:"Detail info",
                                        contentTableAction:function(params){
                                            if(!params.contentTableSelectedRow){
                                                params.thisToolPane.set("content","");
                                                return;
                                            }
                                            var condition={};
                                            condition[reportConfigSelectedRowInfo.sqlParamFieldName]=
                                                    params.contentTableSelectedRow[reportConfigSelectedRowInfo.sqlParamFieldName];
                                            if(!reportConfigSelectedRowInfo.resultType) reportConfigSelectedRowInfo.resultType="item";
                                            Request.getJSONData({url:reportBaseURL+"/getReportRowDataByReportName/"+instance.id,
                                                        condition:condition, resultItemName:reportConfigSelectedRowInfo.resultType},
                                                    function(resultItems){
                                                        if(!resultItems)return;
                                                        var innerCont="";
                                                        if(reportConfigSelectedRowInfo.resultType=="items"){
                                                            for (var i = 0; i < resultItems.length; i++) {
                                                                var resultItem = resultItems[i];
                                                                innerCont+="<b>"+resultItem["DataName"]+"</b>: "+resultItem["DataVal"]+"<br>";
                                                            }
                                                        } else {
                                                            for(var itemName in resultItems){
                                                                innerCont+="<b>"+itemName+"</b>: "+resultItems[itemName]+"<br>";
                                                            }
                                                        }
                                                        params.thisToolPane.set("content",innerCont);
                                                    });
                                        }
                                    })
                                }
                                if(reportConfigTotals){
                                    for(var k = 0; k < reportConfigTotals.length; k++){
                                        var reportConfigTotalData=reportConfigTotals[k];
                                        if(reportConfigTotalData.type=="rowCount"){
                                            button.document.addTotalCountNumberBox(reportConfigTotalData.label, 140, {style:"font-weight:bold;",inputWidth:reportConfigTotalData.inputWidth/*inputStyle:"width:40px;"*/})
                                        }else if(reportConfigTotalData.type=="sum"){
                                            button.document.addTotalSumNumberTextBox(reportConfigTotalData.label,reportConfigTotalData.width, reportConfigTotalData.dataField,
                                                {pattern:reportConfigTotalData.format,style:"font-weight:bold;", inputWidth:reportConfigTotalData.inputWidth})
                                        }
                                    }
                                }
                                button.document.startUp();
                            });
                        }
                        detailContainer.selectChild(button.document);
                    };
                    button.domNode.firstChild.setAttribute("style", "width:160px;");
                    button.startup();
                    buttonList.appendChild(button.domNode);
                    if(!firstButton)firstButton=button;
                };
                pageContainer.createReportButtons();
                pageContainer.layout();
        });
</script>
</html>
