<!DOCTYPE HTML>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div id="reports_retail_PageContainer" style="width:100%;height:100%;">
    <div id="reports_retail_ContentPaneLeft" style="width:177px;height:100%; margin:0;padding:0;">
        <table>
            <tr><th>Отчеты</th></tr>
            <tr><td id="reports_button_list"></td></tr>
        </table>
    </div>
    <div id="reports_retail_ContentPaneDetailContainer" style="width:100%;height:100%; margin:0;padding:0;"></div>
</div>
</body>
<script type="text/javascript">
    require(["app", "dojo/dom-style", "dijit/layout/BorderContainer", "dijit/layout/StackContainer", "dijit/layout/ContentPane",
                "dijit/form/Button", "tDocumentSimpleTable","request"],
            function (APP, domStyle, BorderContainer, StackContainer, ContentPane, Button, TDocumentSimpleTable, Request) {
                var reports_retail_PageContainer=
                        APP.instanceForID("reports_retail_PageContainer", BorderContainer, {});
                APP.instanceForID("reports_retail_ContentPaneLeft", ContentPane, {region:'left', splitter:true});

                var reports_retail_ContentPaneDetailContainer=
                        APP.instanceForID("reports_retail_ContentPaneDetailContainer", StackContainer, {region:'center'});

                var  reports_button_list=document.getElementById("reports_button_list");
                var firstButton;

                reports_retail_PageContainer.createReportButtons=function(){
                    Request.getJSONData({url: "/reports/getReportsList",consoleLog: true},
                            function (data) {
                                if (data===undefined) {
                                    reports_retail_ContentPaneDetailContainer.innerHTML = "<div><b style='color:red'>No connection!</b></div>";
                                    return;
                                }
                                var items=data.items;
                                for (var i in items) {
                                    if(items[i]['id']==undefined){
                                        var div = document.createElement('div');
                                        div.innerHTML='<br>';
                                        document.getElementById('reports_button_list').appendChild(div);
                                        continue;
                                    }
                                    reports_retail_PageContainer.addButtonTo(reports_button_list, items[i].id, items[i].name);
                                }
                               firstButton.onClick();
                            });
                };

                reports_retail_PageContainer.addButtonTo = function (parent, id, name) {
                    var button = new Button({id:id, label:name});
                    button.onClick= function(){
                        var instance=this;
                        if (!button.document){
                            button.document =
                                APP.childFor(reports_retail_ContentPaneDetailContainer, "reports_retail_Table"+instance.id,
                                    TDocumentSimpleTable, {titleText:instance.label, dataURL:'/reports/getReportDataByReportName/'+instance.id});
                            Request.getJSONData({url:'/reports/getReportConfigByReportName/'+instance.id}, function(result){
                                if(result.headers){
                                    for (var i = 0; i < result.headers.length; i++) {
                                        var headerConditionInstance = result.headers[i];
                                        if(headerConditionInstance.type=="selectBox")
                                            button.document.addSelectBox(headerConditionInstance.label,headerConditionInstance.params);
                                        if(headerConditionInstance.type=="dateBox")
                                            button.document.addHeaderDateBox(headerConditionInstance.label,headerConditionInstance.params)
                                    }
                                }
                                if(result.totals){
                                    for(var k = 0; k < result.totals.length; k++){
                                        var totalsItem=result.totals[k];
                                        if(totalsItem.type=="rowCount"){
                                            button.document.addTotalCountNumberBox(totalsItem.label, 140, {style:"font-weight:bold;",inputWidth:totalsItem.inputWidth/*inputStyle:"width:40px;"*/})
                                        }else if(totalsItem.type=="sum"){
                                            button.document.addTotalSumNumberTextBox(totalsItem.label,totalsItem.width, totalsItem.dataField,
                                                {pattern:totalsItem.format,style:"font-weight:bold;", inputWidth:totalsItem.inputWidth})
                                        }
                                    }
                                }
                                button.document.startUp();
                            });
                        }
                        reports_retail_ContentPaneDetailContainer.selectChild(button.document);
                    };
                    button.domNode.firstChild.setAttribute("style", "width:160px;");
                    button.startup();
                    reports_button_list.appendChild(button.domNode);
                    if(!firstButton)firstButton=button;
                };
                reports_retail_PageContainer.createReportButtons();
                reports_retail_PageContainer.layout();
        });
</script>
</html>
